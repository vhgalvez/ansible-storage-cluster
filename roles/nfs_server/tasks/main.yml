---
- name: Detener servicios que puedan usar /dev/vdb
  raw: |
    systemctl stop nfs-server || true
  ignore_errors: true

- name: Eliminar volúmenes lógicos creados por Ansible
  raw: |
    if lvdisplay /dev/vg_data/postgresql_lv >/dev/null 2>&1; then lvremove -y /dev/vg_data/postgresql_lv; fi
    if lvdisplay /dev/vg_data/shared_lv >/dev/null 2>&1; then lvremove -y /dev/vg_data/shared_lv; fi
    if lvdisplay /dev/vg_data/longhorn_lv >/dev/null 2>&1; then lvremove -y /dev/vg_data/longhorn_lv; fi
  ignore_errors: true

- name: Eliminar grupo de volúmenes si está vacío
  raw: |
    if [ "$(vgdisplay vg_data 2>/dev/null | grep 'VG Name')" != "" ]; then
      lv_count=$(lvs --noheadings vg_data | wc -l)
      if [ "$lv_count" -eq 0 ]; then
        vgremove -y vg_data
      fi
    fi
  ignore_errors: true

- name: Eliminar volumen físico solo si es /dev/vdb y no pertenece a otro VG
  raw: |
    if ! pvs /dev/vdb | grep -q vg_data; then
      pvremove -y /dev/vdb || true
    fi
  ignore_errors: true

- name: Crear nuevo volumen físico en /dev/vdb
  raw: pvcreate /dev/vdb
  ignore_errors: false

- name: Crear nuevo grupo de volúmenes
  raw: vgcreate vg_data /dev/vdb
  ignore_errors: false

- name: Crear volumen lógico para PostgreSQL
  raw: lvcreate -L 10G -n postgresql_lv vg_data
  ignore_errors: false

- name: Crear volumen lógico para datos compartidos
  raw: lvcreate -L 10G -n shared_lv vg_data
  ignore_errors: false

- name: Crear volumen lógico para Longhorn
  raw: lvcreate -L 60G -n longhorn_lv vg_data
  ignore_errors: false

- name: Formatear y montar volúmenes
  raw: |
    mkfs.ext4 /dev/vg_data/postgresql_lv
    mkfs.ext4 /dev/vg_data/shared_lv
    mkfs.ext4 /dev/vg_data/longhorn_lv

    mkdir -p /srv/nfs/postgresql
    mkdir -p /srv/nfs/shared
    mkdir -p /mnt/longhorn-disk

    grep -q '/srv/nfs/postgresql' /etc/fstab || echo '/dev/vg_data/postgresql_lv /srv/nfs/postgresql ext4 defaults 0 2' >> /etc/fstab
    grep -q '/srv/nfs/shared'     /etc/fstab || echo '/dev/vg_data/shared_lv     /srv/nfs/shared     ext4 defaults 0 2' >> /etc/fstab
    grep -q '/mnt/longhorn-disk' /etc/fstab || echo '/dev/vg_data/longhorn_lv   /mnt/longhorn-disk ext4 defaults 0 2' >> /etc/fstab

    mount -a